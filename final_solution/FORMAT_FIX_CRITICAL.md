# ⚠️ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ ФОРМАТА

## Проблема

**БЫЛО НЕПРАВИЛЬНО**: p1-p20 = вероятности [0,1]
**ДОЛЖНО БЫТЬ**: p1-p20 = предсказанные доходности (returns)

## Правильный формат

```csv
ticker,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,p20
AFLT,0.0123,-0.0089,0.0234,0.0012,-0.0156,0.0089,0.0145,-0.0023,0.0067,0.0198,-0.0034,0.0123,0.0089,-0.0145,0.0234,0.0067,-0.0089,0.0145,0.0023,-0.0112
SBER,-0.0067,0.0234,0.0089,0.0012,-0.0145,0.0198,0.0034,-0.0089,0.0123,0.0067,0.0145,-0.0023,0.0089,0.0234,-0.0067,0.0112,0.0023,-0.0134,0.0089,0.0045
```

## Что означают значения?

- **p1**: Предсказанная доходность на 1 день вперед
- **p2**: Предсказанная доходность на 2 дня вперед
- ...
- **p20**: Предсказанная доходность на 20 дней вперед

### Примеры:
- `p1 = 0.0123` → ожидается рост на 1.23% через 1 день
- `p5 = -0.0156` → ожидается падение на 1.56% через 5 дней
- `p10 = 0.0198` → ожидается рост на 1.98% через 10 дней

## Исправление в коде

### solution.py - ИСПРАВЛЕНО ✅

Теперь используются **регрессоры** (а не классификаторы):

```python
def _generate_predictions(self, df: pd.DataFrame) -> pd.DataFrame:
    """
    p1-p20 = предсказанные ДОХОДНОСТИ (returns), НЕ вероятности!
    """
    # Используем регрессоры
    pred_agg = self.models[f'lgbm_agg_reg_{horizon}d'].predict(X_tree)[0]
    pred_con = self.models[f'lgbm_con_reg_{horizon}d'].predict(X_tree)[0]
    pred_cat = self.models[f'cat_reg_{horizon}d'].predict(X_tree)[0]
    pred_ridge = self.models[f'ridge_reg_{horizon}d'].predict(X_macro_scaled)[0]

    # Ансамбль с оптимальными весами
    predicted_return = (
        weights[0] * pred_agg +
        weights[1] * pred_con +
        weights[2] * pred_cat +
        weights[3] * pred_ridge
    )

    returns_dict[f'p{horizon}'] = predicted_return  # Это доходность!
```

## Что использует модель

### Регрессоры (для returns):
- LGBM Aggressive Regressor
- LGBM Conservative Regressor
- CatBoost Regressor
- Ridge Regressor

### Классификаторы (НЕ используются в submission):
- Обучены, но не используются для финального submission
- Могут использоваться для анализа

## Диапазон значений

- **Типичный диапазон**: примерно от -0.05 до +0.05 (от -5% до +5%)
- **Может быть шире** для волатильных акций или длинных горизонтов
- **Отрицательные значения** = ожидаемое падение
- **Положительные значения** = ожидаемый рост

## Проверка

После генерации submission проверьте:

```python
import pandas as pd

submission = pd.read_csv('submission.csv')

# Проверка диапазона
for col in submission.columns[1:]:  # Пропускаем ticker
    min_val = submission[col].min()
    max_val = submission[col].max()
    print(f"{col}: min={min_val:.4f}, max={max_val:.4f}")

# Типичные значения должны быть примерно:
# p1: min=-0.03, max=0.03
# p5: min=-0.05, max=0.05
# p20: min=-0.10, max=0.10
```

## Переобучение модели

⚠️ **Старые модели** обучены правильно - регрессоры уже предсказывают returns!

✅ **НЕ нужно** переобучать - просто используйте обновленный `solution.py`

## Что было исправлено

1. `_generate_predictions()` - теперь использует регрессоры вместо классификаторов
2. Default значения: 0.0 (было 0.5)
3. Документация обновлена

---

**Дата исправления**: 2025-10-05
**Версия**: v3.1 (Returns Fix)
